<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>관리자 대시보드 - 홈</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Noto Sans KR -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        /* 기본 폰트를 Noto Sans KR로 설정 */
        body {
            font-family: 'Noto Sans KR', sans-serif;
        }

        /* 커스텀 스크롤바 */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        ::-webkit-scrollbar-thumb {
            background: #aab2bd;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #8892a1;
        }

        /* 드롭다운 메뉴 숨김/표시를 위한 스타일 */
        .submenu {
            display: none;
            overflow: hidden;
            transition: max-height 0.3s ease-in-out;
            max-height: 0;
        }
        .submenu.open {
            display: block;
            max-height: 500px; /* 충분한 높이 */
        }

        /* 캘린더 날짜 셀 최소 높이 */
        .calendar-day {
            min-height: 120px;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <div class="flex h-screen">
        <!-- Sidebar -->
        <aside class="w-64 flex-shrink-0 bg-white border-r border-slate-200 flex flex-col">
            <div class="h-16 flex items-center justify-center border-b border-slate-200">
                <h1 class="text-xl font-bold text-indigo-600">HADASH</h1>
            </div>
            <nav class="flex-1 px-4 py-4 overflow-y-auto">
                <ul class="space-y-1">
                    <li>
                        <a href=".htmindexl" data-page="home" class="nav-link flex items-center px-3 py-2.5 text-sm font-medium text-slate-700 rounded-lg">
                            <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>
                            홈
                        </a>
                    </li>
                    <li>
                        <a href="users.html" data-page="users" class="nav-link flex items-center px-3 py-2.5 text-sm font-medium text-slate-700 rounded-lg">
                            <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M15 21a6 6 0 00-9-5.197m0 0A5.975 5.975 0 0112 13a5.975 5.975 0 013-1.197M15 21a9 9 0 00-6-6.803"></path></svg>
                            사용자 관리
                        </a>
                    </li>
                    <li>
                        <a href="./파일업로드.html" data-page="users" class="nav-link flex items-center px-3 py-2.5 text-sm font-medium text-slate-700 rounded-lg">
                            <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M15 21a6 6 0 00-9-5.197m0 0A5.975 5.975 0 0112 13a5.975 5.975 0 013-1.197M15 21a9 9 0 00-6-6.803"></path></svg>
                            파일 업로드
                        </a>
                    </li>
                    <li>
                        <button type="button" class="nav-accordion flex items-center w-full px-3 py-2.5 text-sm font-medium text-slate-700 rounded-lg text-left" aria-controls="submenu-clients">
                           <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path></svg>
                             <span>클라이언트</span>
                            <svg class="w-4 h-4 ml-auto transition-transform" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
                        </button>
                        <ul id="submenu-clients" class="submenu mt-1 space-y-1 pl-5">
                            <li><a href="./대학교.html" class="nav-link block px-3 py-2 text-sm rounded-lg">대학교</a></li>
                        </ul>
                    </li>
                    <li>
                        <button type="button" class="nav-accordion flex items-center w-full px-3 py-2.5 text-sm font-medium text-slate-700 rounded-lg text-left bg-indigo-50 font-semibold" aria-controls="submenu-services">
                            <svg class="w-5 h-5 mr-3 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>
                            <span class="text-indigo-600">서비스</span>
                            <svg class="w-4 h-4 ml-auto transition-transform rotate-180" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
                        </button>
                        <ul id="submenu-services" class="submenu mt-1 space-y-1 pl-5 open">
                            <li><a href="./신규외국인등록증.html" class="nav-link block px-3 py-2 text-sm rounded-lg text-indigo-600 font-semibold bg-indigo-50">신규 외국인등록증</a></li>
                            <li><a href="#" class="nav-link block px-3 py-2 text-sm rounded-lg">체류기간 연장</a></li>
                            <li><a href="#" class="nav-link block px-3 py-2 text-sm rounded-lg">모바일</a></li>
                        </ul>
                    </li>
                     <li>
                        <a href="./업무진행.html" data-page="work" class="nav-link flex items-center px-3 py-2.5 text-sm font-medium text-slate-700 rounded-lg">
                           <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9V3m0 9a9 9 0 00-9 9"></path></svg>
                            업무 관리
                        </a>
                    </li>
                    <li>
                        <a href="#" data-page="admin" class="nav-link flex items-center px-3 py-2.5 text-sm font-medium text-slate-700 rounded-lg">
                            <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0 3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                            관리자
                        </a>
                    </li>
                </ul>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 overflow-auto p-6 sm:p-8">
            <h2 class="text-2xl font-bold mb-4">홈</h2>
            
            <!-- Service Tabs -->
            <div class="border-b border-slate-200 mb-6">
                <nav class="-mb-px flex space-x-6" aria-label="Tabs">

                    <button data-service="arc" class="service-tab whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm text-slate-500 border-transparent hover:text-slate-700 hover:border-slate-300">
                        신규 외국인등록증
                    </button>
                
                </nav>
            </div>
            
            <!-- Status Cards -->
            <div id="status-cards-container" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 mb-8">
                <div class="bg-white p-4 rounded-lg shadow-sm flex items-center">
                    <div class="p-3 rounded-full bg-blue-100 text-blue-600 mr-4">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                    </div>
                    <div>
                        <p class="text-sm text-slate-500">신청</p>
                        <p data-status="application" class="text-2xl font-bold">0</p>
                    </div>
                </div>
                <div class="bg-white p-4 rounded-lg shadow-sm flex items-center">
                    <div class="p-3 rounded-full bg-yellow-100 text-yellow-600 mr-4">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                    </div>
                    <div>
                        <p class="text-sm text-slate-500">검토 필요</p>
                        <p data-status="review" class="text-2xl font-bold">0</p>
                    </div>
                </div>
                <div class="bg-white p-4 rounded-lg shadow-sm flex items-center">
                    <div class="p-3 rounded-full bg-orange-100 text-orange-600 mr-4">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                    </div>
                    <div>
                        <p class="text-sm text-slate-500">보완 필요</p>
                        <p data-status="revision" class="text-2xl font-bold">0</p>
                    </div>
                </div>
                <div class="bg-white p-4 rounded-lg shadow-sm flex items-center">
                    <div class="p-3 rounded-full bg-indigo-100 text-indigo-600 mr-4">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
                    </div>
                    <div>
                        <p class="text-sm text-slate-500">출입국 제출</p>
                        <p data-status="submitted" class="text-2xl font-bold">0</p>
                    </div>
                </div>
                <div class="bg-white p-4 rounded-lg shadow-sm flex items-center">
                    <div class="p-3 rounded-full bg-red-100 text-red-600 mr-4">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </div>
                    <div>
                        <p class="text-sm text-slate-500">취소</p>
                        <p data-status="canceled" class="text-2xl font-bold">0</p>
                    </div>
                </div>
                <div class="bg-white p-4 rounded-lg shadow-sm flex items-center">
                    <div class="p-3 rounded-full bg-green-100 text-green-600 mr-4">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    </div>
                    <div>
                        <p class="text-sm text-slate-500">발급 완료</p>
                        <p data-status="completed" class="text-2xl font-bold">0</p>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Calendar -->
                <div class="lg:col-span-2 bg-white p-4 sm:p-6 rounded-lg shadow-sm">
                    <div id="calendar-header" class="flex items-center justify-between mb-4">
                        <button id="prev-month" class="p-2 rounded-full hover:bg-slate-100">
                            <svg class="w-6 h-6 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                        </button>
                        <h3 id="month-year" class="text-lg font-bold text-slate-800"></h3>
                        <button id="next-month" class="p-2 rounded-full hover:bg-slate-100">
                            <svg class="w-6 h-6 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                        </button>
                    </div>
                    <!-- Calendar Filters -->
                    <div id="calendar-filters" class="flex flex-wrap gap-x-4 gap-y-2 mb-4 text-sm">
                        <label class="flex items-center"><input type="checkbox" value="application" class="calendar-filter h-4 w-4 rounded text-blue-600 border-slate-300 focus:ring-blue-500"> <span class="ml-2">신청기간</span></label>
                        <label class="flex items-center"><input type="checkbox" value="revision" class="calendar-filter h-4 w-4 rounded text-yellow-600 border-slate-300 focus:ring-yellow-500"> <span class="ml-2">보완 마감일</span></label>
                        <label class="flex items-center"><input type="checkbox" value="fingerprint" class="calendar-filter h-4 w-4 rounded text-indigo-600 border-slate-300 focus:ring-indigo-500"> <span class="ml-2">지문 등록일</span></label>
                        <label class="flex items-center"><input type="checkbox" value="submission" class="calendar-filter h-4 w-4 rounded text-red-600 border-slate-300 focus:ring-red-500"> <span class="ml-2">출입국 제출일</span></label>
                        <label class="flex items-center"><input type="checkbox" value="distribution" class="calendar-filter h-4 w-4 rounded text-purple-600 border-slate-300 focus:ring-purple-500"> <span class="ml-2">RC 배포일</span></label>
                    </div>
                    <div id="calendar-grid" class="relative">
                        <div class="grid grid-cols-7 text-center text-sm font-medium text-slate-500 border-b">
                            <div class="py-2">일</div><div class="py-2">월</div><div class="py-2">화</div><div class="py-2">수</div><div class="py-2">목</div><div class="py-2">금</div><div class="py-2">토</div>
                        </div>
                        <div id="calendar-body" class="grid grid-cols-7">
                            <!-- Calendar day cells are generated here -->
                        </div>
                        <div id="calendar-events" class="absolute top-10 left-0 w-full h-full pointer-events-none pr-2">
                             <!-- Absolutely positioned event bars are generated here -->
                        </div>
                    </div>
                </div>
                <!-- Schedule Summary -->
                <div class="bg-white p-6 rounded-lg shadow-sm">
                    <h3 class="text-lg font-bold mb-4">다가오는 일정</h3>
                    <div id="schedule-summary" class="space-y-4">
                        <!-- Summary items generated by JS -->
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Scripts -->
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // --- Navigation Logic ---
            const navAccordions = document.querySelectorAll('.nav-accordion');
            navAccordions.forEach(accordion => {
                accordion.addEventListener('click', function() {
                    const submenu = this.nextElementSibling;
                    const icon = this.querySelector('svg:last-child');
                    const isOpen = submenu.classList.toggle('open');
                    icon.classList.toggle('rotate-180', isOpen);
                    navAccordions.forEach(otherAccordion => {
                        if (otherAccordion !== this) {
                            otherAccordion.nextElementSibling.classList.remove('open');
                            otherAccordion.querySelector('svg:last-child').classList.remove('rotate-180');
                        }
                    });
                });
            });

            // --- Main Page (Home) Logic ---
            const calendarBody = document.getElementById('calendar-body');
            if (calendarBody) { // Only run main page script if calendar exists
                const calendarEventsContainer = document.getElementById('calendar-events');
                const monthYearEl = document.getElementById('month-year');
                const prevMonthBtn = document.getElementById('prev-month');
                const nextMonthBtn = document.getElementById('next-month');
                const scheduleSummary = document.getElementById('schedule-summary');
                const serviceTabs = document.querySelectorAll('.service-tab');
                const filterCheckboxes = document.querySelectorAll('.calendar-filter');
                
                let currentDate = new Date(2025, 7, 1); // Start in August 2025
                let activeService = 'all';

                const mockStatusCounts = {
                    all: { application: 125, review: 32, revision: 8, submitted: 78, canceled: 5, completed: 65 },
                    arc: { application: 80, review: 15, revision: 6, submitted: 40, canceled: 2, completed: 35 },
                    extension: { application: 45, review: 17, revision: 2, submitted: 38, canceled: 3, completed: 30 }
                };

                const mockEvents = {
                    all: [
                        { id: 1, service: 'arc', type: 'application', startDate: '2025-08-04', endDate: '2025-08-15', title: '한국대 ARC 신청', color: 'bg-blue-500 text-white' },
                        { id: 2, service: 'arc', type: 'revision', startDate: '2025-08-18', endDate: '2025-08-21', title: '한국대 ARC 보완', color: 'bg-yellow-500 text-black' },
                        { id: 3, service: 'extension', type: 'application', startDate: '2025-08-11', endDate: '2025-08-22', title: '연세대 체류연장', color: 'bg-green-500 text-white' },
                        { id: 4, service: 'arc', type: 'submission', startDate: '2025-08-25', endDate: '2025-08-25', title: '출입국 제출 (한국대)', color: 'bg-red-500 text-white' },
                        { id: 5, service: 'extension', type: 'distribution', startDate: '2025-09-01', endDate: '2025-09-05', title: '연세대 RC 배포', color: 'bg-purple-500 text-white' },
                        { id: 6, service: 'arc', type: 'fingerprint', startDate: '2025-09-08', endDate: '2025-09-08', title: '한국대 지문 등록', color: 'bg-indigo-500 text-white' },
                    ],
                    arc: [
                        { id: 1, service: 'arc', type: 'application', startDate: '2025-08-04', endDate: '2025-08-15', title: '한국대 ARC 신청', color: 'bg-blue-500 text-white' },
                        { id: 2, service: 'arc', type: 'revision', startDate: '2025-08-18', endDate: '2025-08-21', title: '한국대 ARC 보완', color: 'bg-yellow-500 text-black' },
                        { id: 4, service: 'arc', type: 'submission', startDate: '2025-08-25', endDate: '2025-08-25', title: '출입국 제출 (한국대)', color: 'bg-red-500 text-white' },
                        { id: 6, service: 'arc', type: 'fingerprint', startDate: '2025-09-08', endDate: '2025-09-08', title: '한국대 지문 등록', color: 'bg-indigo-500 text-white' },
                    ],
                    extension: [
                        { id: 3, service: 'extension', type: 'application', startDate: '2025-08-11', endDate: '2025-08-22', title: '연세대 체류연장', color: 'bg-green-500 text-white' },
                        { id: 5, service: 'extension', type: 'distribution', startDate: '2025-09-01', endDate: '2025-09-05', title: '연세대 RC 배포', color: 'bg-purple-500 text-white' },
                    ]
                };

                function renderAll() {
                    const serviceEvents = mockEvents[activeService] || [];
                    const activeFilters = Array.from(document.querySelectorAll('.calendar-filter:checked')).map(cb => cb.value);
                    
                    const filteredEvents = activeFilters.length === 0 
                        ? serviceEvents 
                        : serviceEvents.filter(e => activeFilters.includes(e.type));

                    renderStatusCards(activeService);
                    renderCalendarBase();
                    renderCalendarEvents(filteredEvents);
                    renderSummary(filteredEvents);
                }
                
                function renderStatusCards(service) {
                    const counts = mockStatusCounts[service];
                    if (!counts) return;

                    for (const [status, count] of Object.entries(counts)) {
                        const el = document.querySelector(`[data-status="${status}"]`);
                        if (el) el.textContent = count;
                    }
                }

                function renderCalendarBase() {
                    calendarBody.innerHTML = '';
                    const year = currentDate.getFullYear();
                    const month = currentDate.getMonth();
                    monthYearEl.textContent = `${year}년 ${month + 1}월`;

                    const firstDayOfMonth = new Date(year, month, 1).getDay();
                    const lastDateOfMonth = new Date(year, month + 1, 0).getDate();
                    
                    let dayCells = '';
                    for (let i = 0; i < firstDayOfMonth; i++) {
                        dayCells += '<div class="border-t border-l"></div>';
                    }

                    for (let day = 1; day <= lastDateOfMonth; day++) {
                        const isToday = new Date().toDateString() === new Date(year, month, day).toDateString();
                        const todayClass = isToday ? 'bg-indigo-50' : '';
                        dayCells += `
                            <div class="calendar-day p-1 border-t border-l ${todayClass}">
                                <div class="text-sm text-center sm:text-left font-semibold ${isToday ? 'text-indigo-600' : ''}">${day}</div>
                            </div>
                        `;
                    }
                    calendarBody.innerHTML = dayCells;
                }

                function renderCalendarEvents(events) {
                    calendarEventsContainer.innerHTML = '';
                    const year = currentDate.getFullYear();
                    const month = currentDate.getMonth();
                    const firstDateOfMonth = new Date(year, month, 1);
                    const lastDateOfMonth = new Date(year, month + 1, 0);

                    const monthEvents = events.filter(event => {
                        const eventStart = new Date(event.startDate + 'T00:00:00');
                        const eventEnd = new Date(event.endDate + 'T00:00:00');
                        return eventStart <= lastDateOfMonth && eventEnd >= firstDateOfMonth;
                    });

                    const eventPositions = []; 

                    const lanes = []; 
                    for(let i=0; i<6; i++) lanes.push([]);

                    monthEvents.sort((a,b) => new Date(a.startDate) - new Date(b.startDate));
                    
                    monthEvents.forEach(event => {
                        const eventStart = new Date(event.startDate + 'T00:00:00');
                        const eventEnd = new Date(event.endDate + 'T00:00:00');
                        
                        let assignedLane = -1;

                        for (let l = 0; l < 10; l++) { // Try up to 10 lanes
                            let laneIsFree = true;
                            for (const pos of eventPositions) {
                                if (pos.lane === l) {
                                    const posEnd = new Date(pos.event.endDate + 'T00:00:00');
                                    if (eventStart <= posEnd && eventEnd >= new Date(pos.event.startDate + 'T00:00:00')) {
                                        laneIsFree = false;
                                        break;
                                    }
                                }
                            }
                            if (laneIsFree) {
                                assignedLane = l;
                                break;
                            }
                        }
                        if (assignedLane === -1) assignedLane = 0; // Fallback

                        eventPositions.push({ event, lane: assignedLane });
                    });
                    
                    eventPositions.forEach(({ event, lane }) => {
                        const eventStart = new Date(event.startDate + 'T00:00:00');
                        const eventEnd = new Date(event.endDate + 'T00:00:00');

                        for(let d = new Date(eventStart); d <= eventEnd; d.setDate(d.getDate() + 7)) {
                            const weekStart = new Date(d);
                            while(weekStart.getDay() !== 0) weekStart.setDate(weekStart.getDate() - 1);
                            
                            const chunkStart = (eventStart > weekStart) ? eventStart : weekStart;
                            
                            const weekEnd = new Date(weekStart);
                            weekEnd.setDate(weekEnd.getDate() + 6);
                            const chunkEnd = (eventEnd < weekEnd) ? eventEnd : weekEnd;

                            if(chunkStart.getMonth() !== month && chunkEnd.getMonth() !== month) continue;
                            if(chunkStart > chunkEnd) continue;

                            const startCol = chunkStart.getMonth() === month ? chunkStart.getDay() : 0;
                            const endCol = chunkEnd.getMonth() === month ? chunkEnd.getDay() : 6;
                            const span = endCol - startCol + 1;

                            const weekIndex = Math.floor((chunkStart.getDate() - 1 + firstDateOfMonth.getDay()) / 7);
                            if (weekIndex < 6) {
                                const dayWidth = calendarBody.offsetWidth / 7;
                                const dayHeight = calendarBody.offsetHeight / (calendarBody.children.length / 7);

                                const eventTop = weekIndex * dayHeight + 30 + lane * 28;
                                const eventLeft = startCol * dayWidth;
                                const eventWidth = span * dayWidth;

                                const eventEl = document.createElement('div');
                                eventEl.className = `absolute p-1 text-xs rounded-md overflow-hidden whitespace-nowrap ${event.color}`;
                                eventEl.style.top = `${eventTop}px`;
                                eventEl.style.left = `${eventLeft}px`;
                                eventEl.style.width = `${eventWidth - 4}px`;
                                eventEl.style.height = '24px';
                                eventEl.textContent = event.title;
                                calendarEventsContainer.appendChild(eventEl);
                            }
                        }
                    });
                }


                function renderSummary(events) {
                    scheduleSummary.innerHTML = '';
                    const upcomingEvents = events
                        .filter(e => new Date(e.endDate) >= new Date(new Date().toDateString()))
                        .sort((a, b) => new Date(a.startDate) - new Date(b.startDate));
                    
                    if (upcomingEvents.length > 0) {
                        upcomingEvents.forEach(event => {
                            const startDate = new Date(event.startDate + 'T00:00:00');
                            const endDate = new Date(event.endDate + 'T00:00:00');
                            const dateString = startDate.getTime() === endDate.getTime()
                                ? `${startDate.getMonth() + 1}월 ${startDate.getDate()}일`
                                : `${startDate.getMonth() + 1}/${startDate.getDate()} ~ ${endDate.getMonth() + 1}/${endDate.getDate()}`;
                            
                            const colorDot = event.color.split(' ')[0];

                            scheduleSummary.innerHTML += `
                                <div class="flex items-start">
                                    <span class="w-3 h-3 mt-1 rounded-full ${colorDot} flex-shrink-0"></span>
                                    <div class="ml-3">
                                        <p class="font-semibold text-sm">${event.title}</p>
                                        <p class="text-xs text-slate-500">${dateString}</p>
                                    </div>
                                </div>
                            `;
                        });
                    } else {
                        scheduleSummary.innerHTML = '<p class="text-sm text-slate-500">다가오는 일정이 없습니다.</p>';
                    }
                }

                prevMonthBtn.addEventListener('click', () => {
                    currentDate.setMonth(currentDate.getMonth() - 1);
                    renderAll();
                });

                nextMonthBtn.addEventListener('click', () => {
                    currentDate.setMonth(currentDate.getMonth() + 1);
                    renderAll();
                });

                serviceTabs.forEach(tab => {
                    tab.addEventListener('click', () => {
                        activeService = tab.dataset.service;
                        serviceTabs.forEach(t => {
                            t.classList.remove('text-indigo-600', 'border-indigo-500');
                            t.classList.add('text-slate-500', 'border-transparent', 'hover:text-slate-700', 'hover:border-slate-300');
                        });
                        tab.classList.add('text-indigo-600', 'border-indigo-500');
                        tab.classList.remove('text-slate-500', 'border-transparent', 'hover:text-slate-700', 'hover:border-slate-300');
                        renderAll();
                    });
                });
                
                filterCheckboxes.forEach(checkbox => {
                    checkbox.addEventListener('change', renderAll);
                });

                new ResizeObserver(() => {
                    // Debounce resize event to avoid excessive re-renders
                    clearTimeout(window.resizeTimer);
                    window.resizeTimer = setTimeout(renderAll, 100);
                }).observe(calendarBody);

                renderAll();
            }
        });
    </script>
</body>
</html>
